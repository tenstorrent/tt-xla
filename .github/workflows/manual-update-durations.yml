name: Update Test Durations

# Minimal POC workflow to validate multi-host setup using mpirun
# Goal: Run hostname checks across all nodes from a single controller

on:
  workflow_dispatch:

permissions:
  packages: read
  contents: read

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  multihost-hostname-check:
    runs-on:
      - multi-host-t3000
      - in-service

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Capture runner's home directory
        id: capture-home
        run: echo "home=${HOME}" >> $GITHUB_OUTPUT

      - name: Pre-check for existing containers
        run: |
          echo "=== Checking for existing multihost-poc containers ==="
          echo ""

          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c '
            if docker ps -a --filter name=multihost-poc --format "{{.Names}}" | grep -q multihost-poc; then
              echo "$(hostname): Found existing multihost-poc container, stopping it..."
              docker stop multihost-poc || true
              docker rm multihost-poc || true
              echo "$(hostname): Cleaned up existing container"
            else
              echo "$(hostname): No existing containers found"
            fi
            '

          echo ""
          echo "Pre-check complete"
          echo ""

      - name: Detect SSH keys on hosts
        run: |
          echo "=== Detecting SSH keys on hosts ==="
          echo ""

          echo "Testing SSH to f10cs03 to discover key location (base64 encoded twice):"
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c 'ssh -v f10cs03 "hostname" 2>&1 | grep -i "identity file\|offering public key\|authentication" | head -10 | base64 -w 0 | base64 -w 0 || true'
          echo ""

          echo ""
          echo "Testing GitHub SSH connection to discover key location:"
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c 'ssh -v -T git@github.com 2>&1 | grep -i "identity file\|offering public key" | head -5 | base64 -w 0 | base64 -w 0 || true'
          echo ""

          echo ""
          echo "Checking standard SSH key locations:"
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c '
            for key in ~/.ssh/id_rsa ~/.ssh/id_ed25519 ~/.ssh/id_ecdsa ${{ steps.capture-home.outputs.home }}/.ssh/id_rsa ${{ steps.capture-home.outputs.home }}/.ssh/id_ed25519; do
              if [ -f "$key" ]; then
                echo "  Found key: $key"
              fi
            done | base64 -w 0 | base64 -w 0
            '
          echo ""

          echo ""

      - name: Validate host-to-host mpirun (bare metal)
        run: |
          echo "=== Bare Metal MPI Validation ==="
          echo ""

          # Check if hostfile exists
          if [ ! -f /etc/mpirun/hostfile ]; then
            echo "ERROR: /etc/mpirun/hostfile not found!"
            exit 1
          fi

          echo "Hostfile found at /etc/mpirun/hostfile"

          # Test host-to-host mpirun
          echo "Testing mpirun hostname on bare metal hosts..."
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            hostname
          echo ""

          echo "Bare metal MPI validation complete!"
          echo ""

      - name: Start SSH agents on all hosts via mpirun
        run: |
          echo "=== Starting SSH agents on all hosts ==="
          echo ""

          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c '
            eval $(ssh-agent -s)
            ssh-add ~/.ssh/id_rsa 2>/dev/null || ssh-add ~/.ssh/id_ed25519 2>/dev/null || ssh-add
            echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" > /tmp/ssh_agent_env
            echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> /tmp/ssh_agent_env
            echo "$(hostname): SSH agent started with PID $SSH_AGENT_PID"
            '

          echo ""
          echo "SSH agents started on all hosts"
          echo ""

      - name: Start containers on all hosts via mpirun
        run: |
          echo "=== Starting containers on all hosts ==="
          echo ""

          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c '
            source /tmp/ssh_agent_env
            CONTAINER_ID=$(docker run --rm -d \
              --name multihost-poc \
              --privileged \
              --pid=host \
              --network=host \
              -v /etc/mpirun:/etc/mpirun:ro \
              -v $SSH_AUTH_SOCK:/ssh-agent \
              -e SSH_AUTH_SOCK=/ssh-agent \
              -v ${{ github.workspace }}:/workspace \
              -w /workspace \
              ghcr.io/tenstorrent/tt-xla/tt-xla-ci-ubuntu-22-04:latest \
              sleep infinity)
            if [ -z "$CONTAINER_ID" ]; then
              echo "$(hostname): ERROR - Failed to start container!"
              exit 1
            fi
            echo "$(hostname): Container started with ID: $CONTAINER_ID"
            '

          echo ""
          echo "Containers started on all hosts"
          echo ""

      - name: Make remote_docker.sh executable in all containers
        run: |
          echo "Making remote_docker.sh executable in all containers..."

          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c 'docker exec multihost-poc chmod +x /workspace/tests/torch/multi_host/experimental/remote_docker.sh'

          echo ""
          echo "Verifying script is executable in containers..."
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c 'docker exec multihost-poc ls -la /workspace/tests/torch/multi_host/experimental/remote_docker.sh'


      - name: Verify SSH agent forwarding in containers
        run: |
          echo "=== Verifying SSH agent forwarding in containers ==="
          echo ""

          echo "Checking SSH_AUTH_SOCK inside containers:"
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c 'docker exec multihost-poc printenv SSH_AUTH_SOCK'
          echo ""

          echo "Checking if SSH agent socket exists inside containers:"
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c 'docker exec multihost-poc ls -la /ssh-agent'
          echo ""

          echo "Testing ssh-add -l inside containers:"
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c 'docker exec multihost-poc ssh-add -l || true'

          echo ""
          echo "SSH agent verification complete"
          echo ""

      - name: Container-to-container SSH smoketest
        run: |
          echo "=== Container-to-container SSH smoketest ==="
          echo ""
          echo "Running mpirun from inside containers with remote_docker.sh as plm_rsh_agent"
          echo ""

          # Run mpirun from inside one of the containers (controller)
          docker exec multihost-poc bash -c '
            mpirun --hostfile /etc/mpirun/hostfile \
              --mca btl_tcp_if_exclude docker0,lo \
              --mca plm_rsh_agent /workspace/tests/torch/multi_host/experimental/remote_docker.sh \
              --tag-output \
              bash -c "echo \"Hostname: \$(hostname)\"; if [ -f /.dockerenv ]; then echo \"Running in container: YES\"; else echo \"Running in container: NO\"; fi"
          '

          echo ""
          echo "Container-to-container SSH smoketest complete"
          echo ""

      - name: Verify containers via mpirun
        run: |
          echo "=== Checking docker ps on all hosts ==="
          echo ""

          echo "Docker ps output (base64 encoded):"
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c 'echo "=== $(hostname) ==="; docker ps --filter name=multihost-poc'
          echo ""
          echo ""

          echo "Verification complete!"
          echo ""

      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleaning up containers and SSH agents on all hosts ==="
          # Note: Containers are created with --rm flag, which automatically removes them when stopped.
          # The 'docker rm' command will fail with "No such container" error - this is expected and harmless.
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c '
            docker stop multihost-poc || true
            docker rm multihost-poc || true
            if [ -f /tmp/ssh_agent_env ]; then
              source /tmp/ssh_agent_env
              kill $SSH_AGENT_PID || true
              rm /tmp/ssh_agent_env
            fi
            echo "$(hostname): Cleanup complete"
            '
          echo "Cleanup complete"

name: Update Test Durations

# Minimal POC workflow to validate multi-host setup using mpirun
# Goal: Run hostname checks across all nodes from a single controller

on:
  workflow_dispatch:

permissions:
  packages: read
  contents: read

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  multihost-hostname-check:
    runs-on:
      - multi-host-t3000
      - in-service

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Capture runner's home directory
        id: capture-home
        run: echo "home=${HOME}" >> $GITHUB_OUTPUT

      - name: Pre-check for existing containers
        run: |
          echo "=== Checking for existing multihost-poc containers ==="
          echo ""

          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c '
            if docker ps -a --filter name=multihost-poc --format "{{.Names}}" | grep -q multihost-poc; then
              echo "$(hostname): Found existing multihost-poc container, stopping it..."
              docker stop multihost-poc || true
              docker rm multihost-poc || true
              echo "$(hostname): Cleaned up existing container"
            else
              echo "$(hostname): No existing containers found"
            fi
            '

          echo ""
          echo "Pre-check complete"
          echo ""

      - name: Validate host-to-host mpirun (bare metal)
        run: |
          echo "=== Bare Metal MPI Validation ==="
          echo ""

          # Check if hostfile exists
          if [ ! -f /etc/mpirun/hostfile ]; then
            echo "ERROR: /etc/mpirun/hostfile not found!"
            exit 1
          fi

          echo "Hostfile found at /etc/mpirun/hostfile"

          # Test host-to-host mpirun
          echo "Testing mpirun hostname on bare metal hosts..."
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            hostname
          echo ""

          echo "Bare metal MPI validation complete!"
          echo ""

      - name: Start SSH agent on controller
        run: |
          echo "=== Starting SSH agent on controller ==="
          echo ""

          eval $(ssh-agent -s)
          ssh-add /home/ubuntu/.ssh/id_rsa_multihost
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" > /tmp/ssh_agent_env
          echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> /tmp/ssh_agent_env
          echo "SSH agent started on controller with PID $SSH_AGENT_PID"

          echo ""
          echo "SSH agent started on controller"
          echo ""

      - name: Start container on controller
        run: |
          echo "=== Starting container on controller ==="
          echo ""

          source /tmp/ssh_agent_env

          # Build docker run command with conditional SSH agent forwarding
          DOCKER_CMD="docker run --rm -d \
            --name multihost-poc \
            --privileged \
            --pid=host \
            --network=host \
            -v /etc/mpirun:/etc/mpirun:ro"

          # Add SSH agent forwarding only if SSH_AUTH_SOCK exists
          if [ -n "$SSH_AUTH_SOCK" ] && [ -S "$SSH_AUTH_SOCK" ]; then
            echo "SSH_AUTH_SOCK found: $SSH_AUTH_SOCK - enabling SSH agent forwarding"
            DOCKER_CMD="$DOCKER_CMD -v $SSH_AUTH_SOCK:/ssh-agent -e SSH_AUTH_SOCK=/ssh-agent"
          else
            echo "Warning: SSH_AUTH_SOCK not found or not a socket - skipping SSH agent forwarding"
          fi

          DOCKER_CMD="$DOCKER_CMD \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/tenstorrent/tt-xla/tt-xla-ci-ubuntu-22-04:latest \
            sleep infinity"

          CONTAINER_ID=$(eval $DOCKER_CMD)
          if [ -z "$CONTAINER_ID" ]; then
            echo "ERROR - Failed to start container on controller!"
            exit 1
          fi
          echo "Container started on controller with ID: $CONTAINER_ID"

          echo ""
          echo "Container started on controller"
          echo ""

      - name: Make remote_docker.sh executable in controller container
        run: |
          echo "Making remote_docker.sh executable in controller container..."

          docker exec multihost-poc chmod +x /workspace/tests/torch/multi_host/experimental/remote_docker.sh

          echo ""
          echo "Verifying script is executable in controller container..."
          docker exec multihost-poc ls -la /workspace/tests/torch/multi_host/experimental/remote_docker.sh


      - name: Verify SSH agent forwarding in controller container
        run: |
          echo "=== Verifying SSH agent forwarding in controller container ==="
          echo ""

          echo "Checking SSH_AUTH_SOCK inside controller container:"
          docker exec multihost-poc printenv SSH_AUTH_SOCK || echo "SSH_AUTH_SOCK not set (expected if SSH agent forwarding was skipped)"
          echo ""

          echo "Checking if SSH agent socket exists inside controller container:"
          docker exec multihost-poc ls -la /ssh-agent 2>/dev/null || echo "SSH agent socket not found (expected if SSH agent forwarding was skipped)"
          echo ""

          echo "Testing ssh-add -l inside controller container:"
          docker exec multihost-poc ssh-add -l || echo "ssh-add failed (expected if SSH agent forwarding was skipped)"

          echo ""
          echo "SSH agent verification complete"
          echo ""

      - name: Container-to-container SSH smoketest
        run: |
          echo "=== Container-to-container SSH smoketest ==="
          echo ""
          echo "Running mpirun from inside containers with remote_docker.sh as plm_rsh_agent"
          echo ""

          # Run mpirun from inside one of the containers (controller)
          docker exec multihost-poc bash -c '
            mpirun --allow-run-as-root \
              --hostfile /etc/mpirun/hostfile \
              --mca btl_tcp_if_exclude docker0,lo \
              --mca plm_rsh_agent /workspace/tests/torch/multi_host/experimental/remote_docker.sh \
              --tag-output \
              bash -c "echo \"Hostname: \$(hostname)\"; if [ -f /.dockerenv ]; then echo \"Running in container: YES\"; else echo \"Running in container: NO\"; fi"
          '

          echo ""
          echo "Container-to-container SSH smoketest complete"
          echo ""

      - name: Verify containers via mpirun
        run: |
          echo "=== Checking docker ps on all hosts ==="
          echo ""

          echo "Docker ps output:"
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c 'echo "=== $(hostname) ==="; docker ps --filter name=multihost-poc'
          echo ""
          echo ""

          echo "Verification complete!"
          echo ""

      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleaning up containers and SSH agents on all hosts ==="
          # Note: Containers are created with --rm flag, which automatically removes them when stopped.
          # The 'docker rm' command will fail with "No such container" error - this is expected and harmless.
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c '
            docker stop multihost-poc || true
            docker rm multihost-poc || true
            if [ -f /tmp/ssh_agent_env ]; then
              source /tmp/ssh_agent_env
              kill $SSH_AGENT_PID || true
              rm /tmp/ssh_agent_env
            fi
            echo "$(hostname): Cleanup complete"
            '
          echo "Cleanup complete"

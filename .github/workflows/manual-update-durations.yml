name: Update Test Durations

# Minimal POC workflow to validate multi-host setup using mpirun
# Goal: Run hostname checks across all nodes from a single controller

on:
  workflow_dispatch:

permissions:
  packages: read
  contents: read

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  multihost-hostname-check:
    runs-on:
      - multi-host-t3000
      - in-service

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Capture runner's home directory
        id: capture-home
        run: echo "home=${HOME}" >> $GITHUB_OUTPUT

      - name: Pre-check for existing containers
        run: |
          echo "=== Checking for existing multihost-poc containers ==="
          echo ""

          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c '
            if docker ps -a --filter name=multihost-poc --format "{{.Names}}" | grep -q multihost-poc; then
              echo "$(hostname): Found existing multihost-poc container, stopping it..."
              docker stop multihost-poc || true
              docker rm multihost-poc || true
              echo "$(hostname): Cleaned up existing container"
            else
              echo "$(hostname): No existing containers found"
            fi
            '

          echo ""
          echo "Pre-check complete"
          echo ""

      - name: Validate host-to-host mpirun (bare metal)
        run: |
          echo "=== Bare Metal MPI Validation ==="
          echo ""

          # Check if hostfile exists
          if [ ! -f /etc/mpirun/hostfile ]; then
            echo "ERROR: /etc/mpirun/hostfile not found!"
            exit 1
          fi

          echo "Hostfile found at /etc/mpirun/hostfile"

          # Test host-to-host mpirun
          echo "Testing mpirun hostname on bare metal hosts..."
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            hostname
          echo ""

          echo "Bare metal MPI validation complete!"
          echo ""

      - name: Start SSH agents on all hosts via mpirun
        run: |
          echo "=== Starting SSH agents on all hosts ==="
          echo ""

          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c '
            eval $(ssh-agent -s)
            ssh-add ~/.ssh/id_rsa 2>/dev/null || ssh-add ~/.ssh/id_ed25519 2>/dev/null || ssh-add
            echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" > /tmp/ssh_agent_env
            echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> /tmp/ssh_agent_env
            echo "$(hostname): SSH agent started with PID $SSH_AGENT_PID"
            '

          echo ""
          echo "SSH agents started on all hosts"
          echo ""

      - name: Start containers on all hosts via mpirun
        run: |
          echo "=== Starting containers on all hosts ==="
          echo ""

          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c '
            source /tmp/ssh_agent_env
            CONTAINER_ID=$(docker run --rm -d \
              --name multihost-poc \
              --privileged \
              --pid=host \
              --network=host \
              -v /etc/mpirun:/etc/mpirun:ro \
              -v $SSH_AUTH_SOCK:/ssh-agent \
              -e SSH_AUTH_SOCK=/ssh-agent \
              -v ${{ github.workspace }}:/workspace \
              -w /workspace \
              ghcr.io/tenstorrent/tt-xla/tt-xla-ci-ubuntu-22-04:latest \
              sleep infinity)
            if [ -z "$CONTAINER_ID" ]; then
              echo "$(hostname): ERROR - Failed to start container!"
              exit 1
            fi
            echo "$(hostname): Container started with ID: $CONTAINER_ID"
            '

          echo ""
          echo "Containers started on all hosts"
          echo ""

      - name: Check /workspace contents in containers
        run: |
          echo "=== Checking /workspace directory in containers ==="
          echo ""

          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c 'docker exec multihost-poc ls -la /workspace'

          echo ""
          echo "/workspace check complete"
          echo ""

      - name: Verify containers via mpirun
        run: |
          echo "=== Checking docker ps on all hosts ==="
          echo ""

          echo "Docker ps output (base64 encoded):"
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c 'echo "=== $(hostname) ==="; docker ps --filter name=multihost-poc' | base64 -w 0
          echo ""
          echo ""

          echo "Verification complete!"
          echo ""

      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleaning up containers and SSH agents on all hosts ==="
          # Note: Containers are created with --rm flag, which automatically removes them when stopped.
          # The 'docker rm' command will fail with "No such container" error - this is expected and harmless.
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            --tag-output \
            bash -c '
            docker stop multihost-poc || true
            docker rm multihost-poc || true
            if [ -f /tmp/ssh_agent_env ]; then
              source /tmp/ssh_agent_env
              kill $SSH_AGENT_PID || true
              rm /tmp/ssh_agent_env
            fi
            echo "$(hostname): Cleanup complete"
            '
          echo "Cleanup complete"

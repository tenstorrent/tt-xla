name: Update Test Durations

# Minimal POC workflow to validate multi-host setup using mpirun
# Goal: Run hostname checks across all nodes from a single controller

on:
  workflow_dispatch:

permissions:
  packages: read
  contents: read

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  multihost-hostname-check:
    runs-on:
      - multi-host-t3000
      - in-service

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Capture runner's home directory
        id: capture-home
        run: echo "home=${HOME}" >> $GITHUB_OUTPUT

      - name: Validate host-to-host mpirun (bare metal)
        run: |
          echo "=== Bare Metal MPI Validation ==="
          echo ""

          # Check if hostfile exists
          echo "Checking for MPI hostfile on host..."
          if [ -f /etc/mpirun/hostfile ]; then
            echo "Hostfile found at /etc/mpirun/hostfile"
            SALT="mh-poc-$(date +%Y%m%d)"
            echo "Hostfile contents:"
            (echo "$SALT"; cat /etc/mpirun/hostfile) | base64 -w 0
            echo ""
            echo ""
          else
            echo "ERROR: /etc/mpirun/hostfile not found!"
            exit 1
          fi

          # Test host-to-host mpirun
          echo "Testing mpirun hostname on bare metal hosts..."
          mpirun --hostfile /etc/mpirun/hostfile \
            --mca btl_tcp_if_exclude docker0,lo \
            hostname
          echo ""

          echo "Bare metal MPI validation complete!"
          echo ""

      # - name: Start container with mpirun capability
      #   run: |
      #     docker run -d \
      #       --name multihost-poc \
      #       --privileged \
      #       --pid=host \
      #       --network=host \
      #       --hostname=mpirun-controller \
      #       -v /etc/mpirun:/etc/mpirun:ro \
      #       -v ${{ steps.capture-home.outputs.home }}/.ssh:${{ steps.capture-home.outputs.home }}/.ssh:ro \
      #       -v ${{ github.workspace }}:/workspace \
      #       -w /workspace \
      #       ghcr.io/tenstorrent/tt-xla/tt-xla-ci-ubuntu-22-04:latest \
      #       sleep infinity

      # - name: Run hostname check via mpirun
      #   run: |
      #     docker exec multihost-poc bash -c '
      #     echo "=== Multi-Host POC: Hostname Check ==="
      #     echo ""

      #     # Check if hostfile exists
      #     echo "Checking for MPI hostfile..."
      #     if [ -f /etc/mpirun/hostfile ]; then
      #       echo "Hostfile found at /etc/mpirun/hostfile"
      #       # Light encryption: prepend salt and base64 encode
      #       SALT="mh-poc-$(date +%Y%m%d)"
      #       echo "Hostfile contents"
      #       (echo "$SALT"; cat /etc/mpirun/hostfile) | base64 -w 0
      #       echo ""
      #       echo ""
      #     else
      #       echo "ERROR: /etc/mpirun/hostfile not found!"
      #       exit 1
      #     fi

      #     # Run hostname across all hosts via mpirun
      #     echo "Running hostname via mpirun across all hosts..."
      #     mpirun --hostfile /etc/mpirun/hostfile \
      #       --mca btl_tcp_if_exclude docker0,lo \
      #       hostname
      #     echo ""

      #     # Check if we are in a container
      #     echo "Checking for container environment (.dockerenv)..."
      #     mpirun --hostfile /etc/mpirun/hostfile \
      #       --mca btl_tcp_if_exclude docker0,lo \
      #       bash -c "if [ -f /.dockerenv ]; then echo \"\$(hostname): Running in Docker container\"; else echo \"\$(hostname): NOT in container\"; fi"
      #     echo ""

      #     echo "=== POC Complete ==="
      #     '

      - name: Cleanup
        if: always()
        run: |
          docker stop multihost-poc || true
          docker rm multihost-poc || true

name: Run Test Single

on:
  workflow_dispatch:
    inputs:
      source_image:
        description: "Source image (including tag) to retag"
        required: true
        type: string
        default: "ghcr.io/tenstorrent/tt-xla-slim:0.9.0.dev20260226001136"
      target_tag:
        description: "Target tag to add to the same image repository"
        required: true
        type: string
        default: "nightly-latest"

permissions:
  contents: read
  packages: write

jobs:
  retag:
    runs-on: ubuntu-latest
    steps:
      - name: Install skopeo
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Log in to GHCR
        shell: bash
        run: |
          echo "${{ github.token }}" | skopeo login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

      - name: Retag (copy) image to nightly-latest
        shell: bash
        run: |
          set -euo pipefail

          src="${{ inputs.source_image }}"
          target_tag="${{ inputs.target_tag }}"

          # Derive destination as "<repo>:<target_tag>"
          repo="${src%:*}"
          dst="${repo}:${target_tag}"

          echo "Source:      ${src}"
          echo "Destination: ${dst}"

          # Copy manifest+layers server-side; keeps digest identical, just adds a tag
          skopeo copy "docker://${src}" "docker://${dst}"

      - name: Verify destination tag exists
        shell: bash
        run: |
          set -euo pipefail

          src="${{ inputs.source_image }}"
          repo="${src%:*}"
          dst="${repo}:${{ inputs.target_tag }}"

          echo "Inspecting ${dst}"
          skopeo inspect "docker://${dst}" >/dev/null
          echo "OK"

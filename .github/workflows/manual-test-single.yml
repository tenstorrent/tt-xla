name: Run Test Single

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag'
        type: string
        required: true

permissions:
  contents: write
  actions: write
  id-token: write
  packages: write
  checks: write

jobs:
  build-image:
    uses: ./.github/workflows/call-build-docker.yml
    secrets: inherit

  build-ttxla:
    uses: ./.github/workflows/call-build.yml
    name: "Build tt-xla"
    secrets: inherit
    needs: build-image
    with:
      docker_image: ${{ needs.build-image.outputs.docker-image }}

  build-release-docker:
    uses: ./.github/workflows/call-build-release-docker.yml
    needs: [ build-ttxla ]
    secrets: inherit
    with:
      wheel_release_artifact_run_id: ${{ needs.build-ttxla.outputs.artifacts_run_id }}
      wheel_release_artifact_name: ${{ needs.build-ttxla.outputs.wheel_artifact_name }}
      wheel_version_override: ${{ inputs.release_tag }}

  # perf-benchmark:
  #   uses: tenstorrent/tt-forge/.github/workflows/perf-benchmark.yml@vvukoman/extract-mlir-version-differently
  #   needs: [ build-release-docker ]
  #   secrets: inherit
  #   with:
  #     ref: vvukoman/extract-mlir-version-differently
  #     docker-image: ${{ needs.build-release-docker.outputs.docker_image }}
  #     project: tt-xla
  #     sh-runner: true

  demo-test:
    uses: tenstorrent/tt-forge/.github/workflows/demo-tests.yml@vvukoman/extract-mlir-version-differently
    needs: [ build-release-docker ]
    secrets: inherit
    with:
      docker-image: ${{ needs.build-release-docker.outputs.docker_image }}
      project-filter: tt-xla
      ref: vvukoman/extract-mlir-version-differently

  # publish-release:
  #   uses: ./.github/workflows/call-publish-release.yml
  #   secrets: inherit
  #   needs: [ build-release-docker, demo-test ]
  #   with:
  #     release_tag: ${{ inputs.release_tag }}
  #     docker_image_base: ${{ needs.build-release-docker.outputs.docker_image_base }}
  #     is_nightly_release: true

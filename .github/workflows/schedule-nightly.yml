name: On nightly

on:
  schedule:
    - cron: '0 0 * * *'

permissions:
  packages: write
  checks: write

jobs:
  build-image:
    uses: ./.github/workflows/call-build-docker.yml
    secrets: inherit

  build-ttxla:
    uses: ./.github/workflows/call-build.yml
    name: "Build tt-xla"
    secrets: inherit
    needs: build-image
    with:
      docker_image: ${{ needs.build-image.outputs.docker-image }}

  nightly_tests:
    uses: ./.github/workflows/call-test.yml
    secrets: inherit
    needs: [ build-image, build-ttxla ]
    with:
      test_suite: basic-test-nightly.json
      codecov: false
      docker_image: ${{ needs.build-image.outputs.docker-image-base }}
      use-shared-runners: false # Run nightly tests on Civ1
      artifact_release_run_id: ${{ needs.build-ttxla.outputs.artifacts_run_id }}
      wheel_release_artifact_name: ${{ needs.build-ttxla.outputs.wheel_artifact_name }}

  # This is a single test job that runs all passing tt-forge-models tests.
  test_forge_models_passing:
    uses: ./.github/workflows/call-test.yml
    secrets: inherit
    needs: [ build-image, build-ttxla ]
    # This ensures the job runs regardless of success or failure of `nightly_tests`:
    if: success() || failure()
    with:
      timeout_minutes: 180
      test_suite: model-test-passing.json
      docker_image: ${{ needs.build-image.outputs.docker-image }}
      use-shared-runners: false # Run full model tests on Civ1
      artifact_release_run_id: ${{ needs.build-ttxla.outputs.artifacts_run_id }}
      wheel_release_artifact_name: ${{ needs.build-ttxla.outputs.wheel_artifact_name }}

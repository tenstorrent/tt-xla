name: Unit Tests (call)

on:
  workflow_call:
    inputs:
      docker_image:
        description: 'Docker image to use for the tests'
        required: true
        type: string
      artifacts_run_id:
        description: 'Run ID of the artifacts'
        required: true
        type: string
      wheel_artifact_name:
        description: 'Name of the wheel artifact'
        required: true
        type: string
      build_artifact_name:
        description: 'Name of the build artifact'
        required: true
        type: string

env:
  GH_TOKEN: ${{ github.token }} # for gh cli tool
  TTMLIR_TOOLCHAIN_DIR: /opt/ttmlir-toolchain
  LD_LIBRARY_PATH: /opt/ttmlir-toolchain/lib:$LD_LIBRARY_PATH
  TT_XLA_CI: 1

jobs:
  # Run unit tests
  run-unit-tests:
    runs-on: ubuntu-latest

    # Keep this name in sync with the fetch-job-id step
    name: "Run PJRT unit tests"

    container:
      image: ${{ inputs.docker_image }}

    steps:
    - name: Mark repo as safe for git
      run: |
        git config --global --add safe.directory /__w/tt-xla/tt-xla

    - uses: actions/checkout@v4
      with:
        submodules: false
        sparse-checkout: |
          python_package/requirements.txt
          venv

    - name: Fetch job id
      id: fetch-job-id
      uses: tenstorrent/tt-github-actions/.github/actions/job_id@main
      with:
        job_name: "Run PJRT unit tests"

    - name: Download and install wheel
      shell: bash
      run: |
        echo "=== Downloading wheel ==="
        echo "Downloading wheel from: ${{ github.repository }} run_id ${{ inputs.artifacts_run_id }} name ${{ inputs.wheel_artifact_name }}"
        gh run download ${{ inputs.artifacts_run_id }} \
          --repo ${{ github.repository }} \
          --dir wheels \
          --name ${{ inputs.wheel_artifact_name }}
        echo "Downloaded wheel files:"
        ls -la wheels

        echo "=== Installing wheel ==="
        source venv/activate
        pip install wheels/*.whl

    - name: Download build artifacts
      run: |
        echo "Downloading build artifacts"
        gh run download ${{ inputs.artifacts_run_id }} \
          --repo ${{ github.repository }} \
          --dir build \
          --name ${{ inputs.build_artifact_name }}
        echo "Untar build artifacts"
        cd build
        tar xf artifact.tar
        rm -f artifact.tar

    - name: Run unit tests
      timeout-minutes: 1
      shell: bash
      run: |
        source venv/activate
        echo "Running PJRT unit tests..."
        find . -iname "libTTMLIRCompiler.so"
        ctest --test-dir build/ -R PJRT -V 2>&1 | tee ctest.log

    - name: Upload test log
      uses: actions/upload-artifact@v4
      if: success() || failure()
      with:
        name: test-log-${{ steps.fetch-job-id.outputs.job_id }}
        path: ctest.log

name: Failure Inspector

on:
  workflow_dispatch:
    inputs:
      workflow_run_id:
        description: 'The workflow run ID to inspect'
        required: true
      workflow_run_attempt:
        description: 'The workflow run attempt number to inspect'
        required: false
        default: '1'
      rerun:
        description: 'Rerun failed jobs?'
        type: boolean
        required: false
        default: false
  workflow_run:
    workflows: On nightly
    branches:
      - main
    types:
      - completed

permissions:
  packages: write
  checks: write

jobs:
  inspect:
    runs-on: ubuntu-latest
    steps:
      - name: Inspect Machine Failures
        id: inspect-failures
        shell: bash
        env:
            GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
            repo="${{ github.repository }}"
            test_job_names=("test ")
            test_step_names=("Collect Tests")

            curr_wf_id="${{ github.event.workflow_run.id || inputs.workflow_run_id }}"
            curr_wf_attempt="${{ github.event.workflow_run.run_attempt || inputs.workflow_run_attempt }}"
            rm -f report.txt

            if ! gh run view -R "$repo" $curr_wf_id --attempt $curr_wf_attempt --json jobs >workflow_jobs.json; then
              echo "ERROR: Failed to fetch workflow jobs."
              exit 1
            fi

            if ! jq empty workflow_jobs.json >/dev/null 2>&1; then
              echo "ERROR: workflow_jobs.json is not valid JSON:"
              cat workflow_jobs.json
              exit 1
            fi

            # Iterate through jobs using index
            job_count=$(jq '.jobs | length' workflow_jobs.json)
            for ((i=0; i<job_count; i++)); do
              job_name=$(jq -r ".jobs[$i].name" workflow_jobs.json)
              job_conclusion=$(jq -r ".jobs[$i].conclusion" workflow_jobs.json)
              if [[ "$job_conclusion" == "success" ]]; then
                continue
              fi

              is_job_test=0
              for test_job_name in "${test_job_names[@]}"; do
                if [[ "$job_name" == *"$test_job_name"* ]]; then
                  is_job_test=1
                  break
                fi
              done
              if [[ "$is_job_test" -eq 1 ]]; then
                echo "Job $i: $job_name"
                steps_count=$(jq ".jobs[$i].steps | length" workflow_jobs.json)
                for ((j=0; j<steps_count; j++)); do
                  step_name=$(jq -r ".jobs[$i].steps[$j].name" workflow_jobs.json)
                  step_conclusion=$(jq -r ".jobs[$i].steps[$j].conclusion" workflow_jobs.json)
                  for test_step_name in "${test_step_names[@]}"; do
                    if [[ "$step_name" == *"$test_step_name"* ]]; then
                      break 2
                    fi
                  done
                  if [[ "$step_conclusion" == "failure" ]]; then
                    job_id=$(jq -r ".jobs[$i].databaseId" workflow_jobs.json)
                    echo "- Failure detected in step '$step_name' before tests are run in job: [$job_name](<https://github.com/$repo/actions/runs/$curr_wf_id/job/$job_id>)" >>report.txt
                  fi
                done
              fi
            done

            if [ ! -s report.txt ]; then
              echo "No failed tests to report."
              echo "send_msg=" >>$GITHUB_OUTPUT
              exit 0
            else
              if [[ "$curr_wf_attempt" -eq 1 ]]; then
                retry=1
                msg_retry_text=":rocket: Retrying failed jobs!"
                echo "> Retry failed job issued!" >> $GITHUB_STEP_SUMMARY
                if [ "${{ inputs.rerun || true }}" == "true" ]; then
                  gh run rerun $curr_wf_id -R "$repo" --failed
                fi
              else
                retry=0
                msg_retry_text="No retries left, already $curr_wf_attempt attempts."
              fi
              echo "Report: $(cat report.txt)"
              echo "## Machine failures inspection report for [Nightly](<https://github.com/$repo/actions/runs/$curr_wf_id/attempts/$curr_wf_attempt>)" >> $GITHUB_STEP_SUMMARY
              cat report.txt >> $GITHUB_STEP_SUMMARY
              echo "send_msg={\"text\": \"Nightly failure caused by machine failures. $msg_retry_text\", \"job_link\": \"https://github.com/$repo/actions/runs/$curr_wf_id/attempts/$curr_wf_attempt\", \"unfurl_links\": false, \"unfurl_media\": false }" >>$GITHUB_OUTPUT
            fi

      - uses: slackapi/slack-github-action@v1.26.0
        if: ${{ steps.inspect-failures.outputs.send_msg }}
        with:
          payload: ${{ steps.inspect-failures.outputs.send_msg }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_NIGHTLY_INSPECT }}

name: Run Test

# This workflow allows manual triggering of tests with customizable presets, hardware targets, and directories.
# It builds the Docker image and project, sets up test parameters, and runs tests using the specified configuration.

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite preset options or custom'
        required: true
        type: choice
        options:
          - 'basic-test.json'
          - 'basic-test-nightly.json'
          - 'model-test-push.json'
          - 'model-test-full.json'
          - 'model-test-passing.json'
          - 'model-test-xfail.json'
          - 'model-test-experimental.json'
          - 'model-test-training.json'
          - 'custom-basic-and-models-push.json'
          - 'vllm-model-tests.json'
          - 'Custom'
      test_suite_custom:
        description: 'Custom test suite json'
        required: false
        type: string
      mlir_override:
        description: 'Git SHA of commit in tenstorrent/tt-mlir'
        required: false
        type: string

permissions:
  packages: write
  checks: write

run-name: 'Test ( Suite: ${{ inputs.test_suite }} )'

jobs:
  build-image:
    uses: ./.github/workflows/call-build-docker.yml
    secrets: inherit
    with:
      mlir_override: ${{ inputs.mlir_override }}

  build-ttxla:
    needs: build-image
    uses: ./.github/workflows/call-build.yml
    secrets: inherit
    with:
      docker_image: ${{ needs.build-image.outputs.docker-image }}
      mlir_override: ${{ inputs.mlir_override }}

  # create-custom-test-name:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     test_job_name: ${{ steps.set-test-job-name.outputs.test_job_name }}
  #   steps:
  #     - name: Set custom test job name based on the test preset file
  #       id: set-test-job-name
  #       shell: bash
  #       run: |
  #         test_job_name="test"
  #         if [ "${{ inputs.test_suite }}" == "model-test-training.json" ]; then
  #           test_job_name="test_forge_models_training"
  #         fi
  #         echo "test_job_name=$test_job_name" >> $GITHUB_OUTPUT

  test:
    if: always() && !cancelled()
    # name: "testing"
    # name: ${{ inputs.test_suite == 'model-test-training.json' && 'test_forge_models_training' || 'test' }}
    # name: ${{ needs.create-custom-test-name.outputs.test_job_name }}
    uses: ./.github/workflows/call-test.yml
    needs: [ build-image, build-ttxla ]
    # needs: [ build-image, build-ttxla, create-custom-test-name ]
    secrets: inherit
    with:
      test_suite: ${{ inputs.test_suite }}
      test_suite_custom: ${{ inputs.test_suite_custom }}
      docker_image: ${{ needs.build-image.outputs.docker-image-base }}
      artifact_release_run_id: ${{ needs.build-ttxla.outputs.artifacts_run_id }}
      wheel_release_artifact_name: ${{ needs.build-ttxla.outputs.wheel_artifact_name }}
      wheel_release_vllm_tt_artifact_name: ${{ needs.build-ttxla.outputs.wheel_release_vllm_tt_artifact_name }}
      codecov: false

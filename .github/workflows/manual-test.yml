name: Run Test

# This workflow allows manual triggering of tests with customizable presets, hardware targets, and directories.
# It builds the Docker image and project, sets up test parameters, and runs tests using the specified configuration.

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite preset options or custom'
        required: true
        type: choice
        options:
          - 'basic-test.json'
          - 'basic-test-nightly.json'
          - 'model-test-push.json'
          - 'model-test-full.json'
          - 'model-test-passing.json'
          - 'model-test-xfail.json'
          - 'model-test-experimental.json'
          - 'model-test-training.json'
          - 'basic-test.json:model-test-push.json' # used for uplifts
          - 'vllm-model-tests.json'
          - 'Custom'
      test_suite_custom:
        description: 'Custom test suite json'
        required: false
        type: string
      mlir_override:
        description: 'Git SHA of commit in tenstorrent/tt-mlir'
        required: false
        type: string

permissions:
  packages: write
  checks: write

run-name: 'Test ( Suite: ${{ inputs.test_suite }} )'

jobs:
  build-image:
    uses: ./.github/workflows/call-build-docker.yml
    secrets: inherit
    with:
      mlir_override: ${{ inputs.mlir_override }}

  fetch-wheel:
    runs-on: wormhole_b0
    needs: build-image
    env:
      DOCKER_CACHE_ROOT: '/mnt/dockercache'
    steps: 
      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: torch-xla-wheel
          path: /mnt/dockercache/models/tt-ci-models-private/wheels/torch_xla-2.9.0+git1f21467*.whl

  build-ttxla:
    needs: [build-image, fetch-wheel]
    uses: ./.github/workflows/call-build.yml
    secrets: inherit
    with:
      docker_image: ${{ needs.build-image.outputs.docker-image }}
      mlir_override: ${{ inputs.mlir_override }}
      wheel_artifact: torch-xla-wheel 

  test:
    if: success() && !cancelled() && inputs.preset != 'tt_forge_models'
    uses: ./.github/workflows/call-test.yml
    needs: [ build-image, build-ttxla]
    secrets: inherit
    with:
      test_suite: ${{ inputs.test_suite }}
      test_suite_custom: ${{ inputs.test_suite_custom }}
      docker_image: ${{ needs.build-image.outputs.docker-image-base }}
      artifact_release_run_id: ${{ needs.build-ttxla.outputs.artifacts_run_id }}
      wheel_release_artifact_name: ${{ needs.build-ttxla.outputs.wheel_artifact_name }}
      wheel_release_vllm_tt_artifact_name: ${{ needs.build-ttxla.outputs.wheel_release_vllm_tt_artifact_name }}
      codecov: false
      wheel_artifact: torch-xla-wheel

name: Run Test

on:
  workflow_dispatch:
    inputs:
      rebuild_xla:
        description: 'Rebuild XLA'
        required: false
        type: boolean
      preset:
        description: 'Preset to use for the tests'
        type: choice
        default: 'nightly'
        options:
          - 'push'
          - 'nightly'
          - 'model_test'
          - 'Custom'
      test_mark:
        description: 'Test mark to run (if preset is Custom)'
        type: string

jobs:
  build-image:
    uses: ./.github/workflows/build-image.yml
    secrets: inherit

  build-xla:
    if: inputs.rebuild_xla
    uses: ./.github/workflows/build.yml
    secrets: inherit
    needs: build-image
    with:
      docker_image: ${{ needs.build-image.outputs.docker-image }}

  build-resolution:
    runs-on: ubuntu-latest
    needs: build-xla
    if: always() && !cancelled()
    outputs:
      run_id: ${{ steps.set_inputs.outputs.run_id }}
      test_mark: ${{ steps.set_inputs.outputs.test_mark }}
    steps:
      - id: set_inputs
        run: |
          echo "run_id=$(if [ '${{ inputs.rebuild_xla }}' == 'true' ]; then echo ${{ github.run_id }}; fi;)" >> $GITHUB_OUTPUT
          if [ '${{ inputs.preset }}' == 'Custom' ]; then
            echo "test_mark=${{ inputs.test_mark }}" >> $GITHUB_OUTPUT
          else
            echo "test_mark=${{ inputs.preset }}" >> $GITHUB_OUTPUT
          fi

  test:
    if: always() && !cancelled()
    uses: ./.github/workflows/test.yml
    needs: [build-image,build-resolution]
    secrets: inherit
    with:
      docker_image: ${{ needs.build-image.outputs.docker-image }}
      test_mark: ${{ needs.build-resolution.outputs.test_mark }}
      run_id: ${{ needs.build-resolution.outputs.run_id }}

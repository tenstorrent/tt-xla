{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://tenstorrent.com/schemas/test-config.schema.json",
  "title": "Test Configuration Schema",
  "description": "Schema for validating YAML test configuration files in tests/runner/test_config/",
  "type": "object",
  "properties": {
    "test_config": {
      "type": "object",
      "description": "Test configuration entries",
      "patternProperties": {
        "^.+$": {
          "$ref": "#/definitions/testEntry"
        }
      },
      "additionalProperties": false
    },
    "PLACEHOLDER_MODELS": {
      "type": "object",
      "description": "Placeholder model configurations (torch only)",
      "patternProperties": {
        "^.+$": {
          "$ref": "#/definitions/testEntry"
        }
      },
      "additionalProperties": false
    }
  },
  "anyOf": [
    {
      "required": ["test_config"]
    },
    {
      "required": ["PLACEHOLDER_MODELS"]
    }
  ],
  "additionalProperties": false,
  "definitions": {
    "testEntry": {
      "type": "object",
      "description": "Configuration for a single test. Either 'status' or 'bringup_status' is required at top level, unless arch_overrides contains status fields.",
      "properties": {
        "status": {
          "type": "string",
          "description": "Test execution status (required)",
          "enum": [
            "EXPECTED_PASSING",
            "KNOWN_FAILURE_XFAIL",
            "NOT_SUPPORTED_SKIP",
            "UNSPECIFIED",
            "EXCLUDE_MODEL",
            "expected_passing",
            "known_failure_xfail",
            "not_supported_skip",
            "unspecified",
            "exclude_model"
          ]
        },
        "reason": {
          "type": "string",
          "description": "Explanation for the test status, especially for failures or skips"
        },
        "bringup_status": {
          "type": "string",
          "description": "Detailed failure categorization (optional)",
          "enum": [
            "FAILED_FE_COMPILATION",
            "FAILED_TTMLIR_COMPILATION",
            "FAILED_RUNTIME",
            "INCORRECT_RESULT",
            "PASSED",
            "UNKNOWN",
            "NOT_STARTED",
            "failed_fe_compilation",
            "failed_ttmlir_compilation",
            "failed_runtime",
            "incorrect_result",
            "passed",
            "unknown",
            "not_started"
          ]
        },
        "required_pcc": {
          "type": "number",
          "description": "Required Pearson Correlation Coefficient for output comparison",
          "minimum": 0,
          "maximum": 1
        },
        "assert_pcc": {
          "type": "boolean",
          "description": "Whether to assert on PCC comparison"
        },
        "assert_atol": {
          "type": "boolean",
          "description": "Whether to enable absolute tolerance comparator"
        },
        "required_atol": {
          "type": "number",
          "description": "Required absolute tolerance",
          "minimum": 0
        },
        "assert_allclose": {
          "type": "boolean",
          "description": "Whether to enable allclose comparator"
        },
        "allclose_rtol": {
          "type": "number",
          "description": "Relative tolerance for allclose",
          "minimum": 0
        },
        "allclose_atol": {
          "type": "number",
          "description": "Absolute tolerance for allclose",
          "minimum": 0
        },
        "markers": {
          "type": "array",
          "description": "Pytest markers to apply (e.g., push, nightly, large)",
          "items": {
            "type": "string"
          },
          "uniqueItems": true
        },
        "supported_archs": {
          "type": "array",
          "description": "List of supported architectures (e.g., p150, n300, n300-llmbox)",
          "items": {
            "type": "string"
          },
          "uniqueItems": true
        },
        "batch_size": {
          "type": "integer",
          "description": "Override default batch size",
          "minimum": 1
        },
        "execution_pass": {
          "type": "string",
          "description": "Execution pass type (for training tests)",
          "enum": [
            "FORWARD",
            "BACKWARD",
            "forward",
            "backward"
          ]
        },
        "filechecks": {
          "type": "array",
          "description": "List of filecheck pattern files from tests/filecheck/",
          "items": {
            "type": "string",
            "pattern": "^[a-zA-Z0-9_.-]+\\.(mlir|txt)$"
          },
          "uniqueItems": true
        },
        "arch_overrides": {
          "type": "object",
          "description": "Per-architecture configuration overrides",
          "patternProperties": {
            "^[a-zA-Z0-9_-]+$": {
              "$ref": "#/definitions/archOverride"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "archOverride": {
      "type": "object",
      "description": "Architecture-specific configuration override",
      "properties": {
        "status": {
          "type": "string",
          "description": "Override test execution status for this architecture",
          "enum": [
            "EXPECTED_PASSING",
            "KNOWN_FAILURE_XFAIL",
            "NOT_SUPPORTED_SKIP",
            "UNSPECIFIED",
            "EXCLUDE_MODEL",
            "expected_passing",
            "known_failure_xfail",
            "not_supported_skip",
            "unspecified",
            "exclude_model"
          ]
        },
        "reason": {
          "type": "string",
          "description": "Explanation for the architecture-specific override"
        },
        "bringup_status": {
          "type": "string",
          "description": "Architecture-specific bringup status",
          "enum": [
            "FAILED_FE_COMPILATION",
            "FAILED_TTMLIR_COMPILATION",
            "FAILED_RUNTIME",
            "INCORRECT_RESULT",
            "PASSED",
            "UNKNOWN",
            "NOT_STARTED",
            "failed_fe_compilation",
            "failed_ttmlir_compilation",
            "failed_runtime",
            "incorrect_result",
            "passed",
            "unknown",
            "not_started"
          ]
        },
        "required_pcc": {
          "type": "number",
          "description": "Architecture-specific required PCC",
          "minimum": 0,
          "maximum": 1
        },
        "assert_pcc": {
          "type": "boolean",
          "description": "Architecture-specific PCC assertion"
        },
        "assert_atol": {
          "type": "boolean",
          "description": "Architecture-specific absolute tolerance assertion"
        },
        "required_atol": {
          "type": "number",
          "description": "Architecture-specific required absolute tolerance",
          "minimum": 0
        },
        "assert_allclose": {
          "type": "boolean",
          "description": "Architecture-specific allclose assertion"
        },
        "allclose_rtol": {
          "type": "number",
          "description": "Architecture-specific relative tolerance",
          "minimum": 0
        },
        "allclose_atol": {
          "type": "number",
          "description": "Architecture-specific absolute tolerance",
          "minimum": 0
        },
        "markers": {
          "type": "array",
          "description": "Architecture-specific pytest markers",
          "items": {
            "type": "string"
          },
          "uniqueItems": true
        },
        "batch_size": {
          "type": "integer",
          "description": "Architecture-specific batch size",
          "minimum": 1
        },
        "execution_pass": {
          "type": "string",
          "description": "Architecture-specific execution pass",
          "enum": [
            "FORWARD",
            "BACKWARD",
            "forward",
            "backward"
          ]
        },
        "filechecks": {
          "type": "array",
          "description": "Architecture-specific filecheck patterns",
          "items": {
            "type": "string",
            "pattern": "^[a-zA-Z0-9_.-]+\\.(mlir|txt)$"
          },
          "uniqueItems": true
        }
      },
      "additionalProperties": false
    }
  }
}

# SPDX-FileCopyrightText: Â© 2024 Tenstorrent AI ULC
#
# SPDX-License-Identifier: Apache-2.0
#

if [ -z "$TTMLIR_TOOLCHAIN_DIR" ]; then
  echo "WARNING: TTMLIR_TOOLCHAIN_DIR not set. Using default value /opt/ttmlir-toolchain"
  export TTMLIR_TOOLCHAIN_DIR="/opt/ttmlir-toolchain"
fi
export LD_LIBRARY_PATH=$TTMLIR_TOOLCHAIN_DIR/lib:$LD_LIBRARY_PATH
export SYSTEM_DIST_PACKAGES="/usr/local/lib/python3.11/dist-packages"
export PYTHONPATH="$(pwd):$(pwd)/tests:$SYSTEM_DIST_PACKAGES:$(pwd)/integrations/vllm_plugin:$(pwd)/third_party/tt-mlir/src/tt-mlir/build/python_packages"
# pytest alias for venv interpreter
alias pytest='python -m pytest'

export TTMLIR_VENV_DIR="$(pwd)/venv"
if [ -d $TTMLIR_VENV_DIR/bin ]; then
  [ -f $TTMLIR_VENV_DIR/bin/activate ] && source $TTMLIR_VENV_DIR/bin/activate
else
  echo "Creating virtual environment in $TTMLIR_VENV_DIR"
  python3.11 -m venv $TTMLIR_VENV_DIR
  source $TTMLIR_VENV_DIR/bin/activate
  pip install --upgrade pip
  # Requirements for third party projects are installed during their build in `CMakeLists.txt`
  pip install -r python_package/requirements.txt
  # Install dev/test requirements
  pip install -r venv/requirements-dev.txt
fi

export VLLM_TARGET_DEVICE="empty"

export TTXLA_ENV_ACTIVATED=1
export TTMLIR_ENV_ACTIVATED=1
export TT_METAL_LOGGER_LEVEL="ERROR"
export ARCH_NAME="${ARCH_NAME:-wormhole_b0}"
export TT_MLIR_HOME="$(pwd)/third_party/tt-mlir/src/tt-mlir/"
export PATH=$TTMLIR_TOOLCHAIN_DIR/bin:${TT_MLIR_HOME}/build/bin:$PATH


# Check if TT_MLIR_HOME is set
if [[ -z "${TT_MLIR_HOME}" ]]; then
    echo "Error: TT_MLIR_HOME environment variable is not set"
    exit 1
fi
# Check if TT_METAL_RUNTIME_ROOT is set
if [[ -z "${TT_METAL_RUNTIME_ROOT}" ]]; then
    export TT_METAL_RUNTIME_ROOT="${TT_MLIR_HOME}/third_party/tt-metal/src/tt-metal"
    echo "TT_METAL_RUNTIME_ROOT is not set. Setting it to ${TT_METAL_RUNTIME_ROOT}"
fi
# Confirm python3 exists
if ! command -v python3 &> /dev/null; then
    echo "Error: python3 could not be found"
    exit 1
fi
# If ttnn module is not in PYTHONPATH, add it
if [[ ":$PYTHONPATH:" != *":${TT_METAL_RUNTIME_ROOT}/ttnn:"* ]]; then
    # This covers the corner case where PYTHONPATH is not set, avoids leading colon
    export PYTHONPATH="${PYTHONPATH:+${PYTHONPATH}:}${TT_METAL_RUNTIME_ROOT}/ttnn"
fi

# If tracy module is not in PYTHONPATH, add it
if [[ ":$PYTHONPATH:" != *":${TT_METAL_RUNTIME_ROOT}/tools/:"* ]]; then
    export PYTHONPATH="${PYTHONPATH:+${PYTHONPATH}:}${TT_METAL_RUNTIME_ROOT}/tools/"
fi
